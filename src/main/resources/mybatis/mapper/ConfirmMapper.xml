<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.example.renewal_firstclass.dao.ConfirmApplyDAO">

<insert id="insertConfirmApplication"
        parameterType="com.example.renewal_firstclass.domain.ConfirmApplyDTO"
        useGeneratedKeys="true"
        keyProperty="confirmNumber" 
        keyColumn="confirm_number">
  INSERT INTO TB_CONFIRM_APPLICATION (
    start_date, end_date,
    weekly_hours, regular_wage,
    child_name, child_resi_regi_number, child_birth_date,
    registration_number, name,
    response_name, response_phone_number,
    status_code, center_id, user_id
  ) VALUES (
    #{startDate}, #{endDate},
    #{weeklyHours}, #{regularWage},
    #{childName}, #{childResiRegiNumber}, #{childBirthDate},
    #{registrationNumber}, #{name},
    #{responseName}, #{responsePhoneNumber},
    'ST_10', #{centerId}, #{userId}
  )
</insert>

 <update id="updateDraft"
          parameterType="com.example.renewal_firstclass.domain.ConfirmApplyDTO">
    UPDATE TB_CONFIRM_APPLICATION
       SET start_date             = #{startDate},
           end_date               = #{endDate},
           weekly_hours           = #{weeklyHours},
           regular_wage           = #{regularWage},
           child_name             = #{childName},
           child_resi_regi_number = #{childResiRegiNumber},
           child_birth_date       = #{childBirthDate},
           registration_number    = #{registrationNumber},
           name                   = #{name},
           response_name          = #{responseName},
           response_phone_number  = #{responsePhoneNumber}
     WHERE confirm_number             = #{confirmNumber}
       AND user_id                = #{userId}
       AND status_code            = 'ST_10'
       AND NVL(delt_at, 'N')      = 'N'
  </update>

  <update id="submitConfirm"
          parameterType="map">
    UPDATE TB_CONFIRM_APPLICATION
       SET status_code = 'ST_20',
           apply_dt    = NVL(apply_dt, SYSDATE)
     WHERE confirm_number  = #{confirmNumber}
       AND user_id     = #{userId}
       AND status_code = 'ST_10'
       AND NVL(delt_at, 'N') = 'N'
  </update>

<select id="selectByConfirmNumber"
        parameterType="long"
        resultType="com.example.renewal_firstclass.domain.ConfirmApplyDTO">
  SELECT
    confirm_number,
    apply_dt,
    start_date,
    end_date,
    weekly_hours,
    regular_wage,
    child_name,
    child_resi_regi_number,
    child_birth_date,
    registration_number,
    name,
    response_name,
    response_phone_number,
    status_code,
    processor_id,
    center_id,
    user_id
  FROM TB_CONFIRM_APPLICATION
  WHERE confirm_number = #{confirmNumber}
    AND NVL(delt_at,'N') = 'N'
</select>


<select id="selectByUserId" parameterType="long"
        resultType="com.example.renewal_firstclass.domain.ConfirmListDTO">
  SELECT
    ca.confirm_number,
    ca.apply_dt,
    ca.status_code,
    ca.name,
    c.name AS statusName
  FROM TB_CONFIRM_APPLICATION ca
  LEFT JOIN TB_CODE c
    ON ca.status_code = c.code
  WHERE ca.user_id = #{userId}
  ORDER BY ca.apply_dt DESC
</select>



</mapper>