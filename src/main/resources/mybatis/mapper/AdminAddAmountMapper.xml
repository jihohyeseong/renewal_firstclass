<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.renewal_firstclass.dao.AdminAddAmountDAO">

    <sql id="searchCondition">
        <where>
            <if test="nameKeyword != null and nameKeyword != ''">
                AND (u.name LIKE '%' || #{nameKeyword} || '%' OR p.application_number LIKE '%' || #{nameKeyword} || '%')
            </if>
            <if test="appNoKeyword != null">
                AND p.application_number LIKE '%' || #{appNoKeyword} || '%'
            </if>
            
            AND p.status_code = 'ST_50'
            
            <if test="status != null and status != ''">
                <choose>
                    <when test="status == 'PENDING'">
                        AND a.application_number IS NULL
                    </when>
                    <when test="status == 'APPROVED'">
                        AND a.status_code = 'ST_50'
                    </when>
                    <when test="status == 'REJECTED'">
                        AND a.status_code = 'ST_60'
                    </when>
                    </choose>
            </if>
            <if test="status == null or status == ''">
                </if>
            
            <if test="date != null and date != ''">
                AND TO_CHAR(p.submitted_dt, 'YYYY-MM-DD') = #{date}
            </if>
            AND p.delt_at = 'N'
            AND p.payment_result = 'Y'
        </where>
    </sql>

    <select id="selectApplicationList" resultType="com.example.renewal_firstclass.domain.AdminUserApprovalDTO">
        SELECT
            p.application_number AS applicationNumber,
            p.user_id AS userId,
            ca.name AS applicantName,
            p.status_code AS statusCode,
            TO_CHAR(p.submitted_dt, 'YYYY-MM-DD') AS submittedDate,
            p.payment_result AS paymentResult,
            CASE
                WHEN p.status_code = 'ST_50' AND a.status_code = 'ST_40' THEN '추가지급 대기'
                WHEN p.status_code = 'ST_50' AND a.status_code = 'ST_50' THEN '추가지급 결정'
                WHEN p.status_code = 'ST_50' AND a.status_code = 'ST_60' THEN '추가지급 반려'
                WHEN p.status_code = 'ST_50' THEN '최종 지급 승인'
                ELSE '기타'
            END AS statusName
        FROM TB_PARENTAL_LEAVE_APPLICATION p
        JOIN TB_User u ON p.user_id = u.id
        JOIN TB_CONFIRM_APPLICATION ca ON ca.confirm_number = p.confirm_number
        LEFT JOIN (
		    SELECT application_number, MIN(status_code) AS status_code
		    FROM TB_ADD_AMOUNT
		    GROUP BY application_number
		) a ON p.application_number = a.application_number
        <include refid="searchCondition"/>
        ORDER BY p.application_number DESC
        OFFSET #{pageDTO.startList} ROWS FETCH NEXT #{pageDTO.listSize} ROWS ONLY
    </select>
    
    <select id="selectTotalCount" resultType="int">
        SELECT 
            COUNT(DISTINCT p.application_number)
        FROM 
            TB_PARENTAL_LEAVE_APPLICATION p
        JOIN
            TB_User u ON p.user_id = u.id
        LEFT JOIN 
            TB_ADD_AMOUNT a ON p.application_number = a.application_number
        <include refid="searchCondition"/>
    </select>

    <select id="selectStatusCount" resultType="int">
        SELECT COUNT(*)
        FROM TB_PARENTAL_LEAVE_APPLICATION
        WHERE status_code = #{statusCode}
          AND delt_at = 'N'
          AND payment_result = #{paymentResult}
    </select>
	
	<select id="selectAppDetailByAppNo"
        resultType="com.example.renewal_firstclass.domain.AdminUserApprovalDTO">
	  SELECT
	    /* ===== 신청서(PLA) ===== */
	    p.application_number,
	    p.status_code,
	    st_app.name                  AS statusName,
	    p.bank_code,
	    bank.name                    AS bankName,
	    p.account_number,
	    p.payment_result,
	    p.payment,
	    p.submitted_dt,
	    p.examine_dt,
	    p.rejection_reason_code,
	    rj.name                      AS rejectionReasonName,
	    p.reject_comment,
	    p.gov_info_agree,
	    p.center_id,
	    p.confirm_number,
	    p.user_id,                   -- 신청자 ID
	    p.processor_id,
	    p.superior_id,
	
	    /* ===== 확인서(CA) ===== */
	    c.start_date,
	    c.end_date,
	    c.weekly_hours,
	    c.regular_wage,
	    c.child_name,
	    c.child_resi_regi_number,
	    c.child_birth_date,
	    c.registration_number        AS applicantResiRegiNumber,  -- 근로자 주민번호(확인서에 저장됨)
	    c.name                       AS applicantNameFromCA,     -- 근로자 이름(확인서에 저장)
	    c.response_name,
	    c.response_phone_number,
	    c.user_id        AS corpUserId,   -- 회사계정 ID (참고용 필요시)
	    c.center_id      AS corpCenterId, -- 회사의 소속 센터 (필요시)
	
	    /* ===== 신청자(USER, from PLA.user_id) ===== */
	    au.name                      AS applicantName,           -- 신청자 이름(사용자 테이블)
	    au.phone_number              AS applicantPhoneNumber,
	    au.zip_number				 AS applicantZipNumber,
	    au.address_base              AS applicantAddrBase,
	    au.address_detail            AS applicantAddrDetail,
	
	    /* ===== 회사(USER, from CA.user_id) ===== */
	    cu.name                      AS businessName,            -- 회사명
	    cu.zip_number                  AS businessZipNumber,
	    cu.address_base              AS businessAddrBase,
	    cu.address_detail            AS businessAddrDetail,
	    cu.buisiness_regi_number     AS businessRegiNumber,
	
	    /* ===== 처리자(USER) ===== */
	    pu_proc.name                      AS processorName,
	    pu_sup.name					      AS superiorName
	
	  FROM TB_PARENTAL_LEAVE_APPLICATION p
	  JOIN TB_CONFIRM_APPLICATION c ON c.confirm_number = p.confirm_number
	
	  /* 신청자(근로자) */
	  JOIN TB_USER au ON au.id = p.user_id
	
	  /* 처리자(관리자) */
	  LEFT JOIN TB_USER pu_proc ON pu_proc.id = p.processor_id
	  
	  /* 처리자(상위 관리자) */
	  LEFT JOIN TB_USER pu_sup ON pu_sup.id = p.superior_id
	
	  /* 회사(사업장) — 확인서의 user_id */
	  LEFT JOIN TB_USER cu ON cu.id = c.user_id
	
	  /* 코드 */
	  LEFT JOIN TB_CODE bank   ON bank.code = p.bank_code
	  LEFT JOIN TB_CODE st_app ON st_app.code = p.status_code
	  LEFT JOIN TB_CODE rj     ON rj.code   = p.rejection_reason_code
	
	  WHERE p.application_number = #{applicationNumber}
	    AND NVL(p.delt_at, 'N') = 'N'
	</select>
	
	<select id="selectAddAmountDetails" resultType="com.example.renewal_firstclass.domain.AdminAddAmountDTO">
        SELECT
            a.term_id AS termId,
            a.code_id AS codeId,
            c.name AS addReasonName, a.amount,
            a.add_reason AS addReason, a.status_code AS statusCode
        FROM
            TB_ADD_AMOUNT a
        LEFT JOIN
            TB_CODE c ON a.code_id = c.code_id
        WHERE
            a.application_number = #{applicationNumber}
        ORDER BY
            a.term_id
    </select>
    
	<!-- 추가지급 신청 -->
	<insert id="applyAddAmount" parameterType="java.util.List">
		BEGIN
		  <foreach collection="add" item="a">
			  INSERT INTO TB_ADD_AMOUNT (
				term_id, code_id,
			  	amount, add_reason, status_code,
			  	application_number
			  	) VALUES (
			      #{a.termId},
			      #{a.codeId},
			      #{a.amount},
			      #{a.addReason},
			      #{a.statusCode},
			      #{a.applicationNumber}
		    	);
		</foreach>
		END;
	</insert>
	
	<select id="selectAddAmountReasonCodes" resultType="java.util.Map">
        SELECT
            code_id AS "codeId",
            name AS "name",
            code AS "code"
        FROM
            TB_CODE
        WHERE
            code IN ('AR_10', 'AR_20', 'AR_30')
        ORDER BY
            code
    </select>
</mapper>