<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.renewal_firstclass.dao.AdminAddAmountDAO">

    <sql id="searchCondition">
        <where>
          
            <if test="nameKeyword != null and nameKeyword != ''">
                AND (u.name LIKE '%' || #{nameKeyword} || '%' OR p.application_number LIKE '%' || #{nameKeyword} || '%')
            </if>
            <if test="appNoKeyword != null">
            	AND p.application_number LIKE '%' || #{appNoKeyword} || '%'
            </if>
            <if test="status != null and status != ''">
                <choose>
	                <when test="status == 'PENDING'">
	                    AND p.status_code = 'ST_80' AND p.payment_result = 'Y'
	                </when>
	                <when test="status == 'APPROVED'">
	                    AND p.status_code = 'ST_90' AND p.payment_result = 'Y'
	                </when>
	                <when test="status == 'REJECTED'">
	                    AND p.status_code = 'ST_100' AND p.payment_result = 'Y'
	                </when>
	                <when test="status == 'ST_50'">
                        AND p.status_code = 'ST_50'
                    </when>
            	</choose>
            </if>
            <if test="date != null and date != ''">
            	AND TO_CHAR(p.submitted_dt, 'YYYY-MM-DD') = #{date}
            </if>
            AND p.delt_at = 'N'
            AND p.status_code != 'ST_10'
            AND p.status_code != 'ST_70'
        </where>
    </sql>

    <select id="selectApplicationList" resultType="com.example.renewal_firstclass.domain.AdminUserApprovalDTO">
        SELECT
            p.application_number AS applicationNumber,
            p.user_id AS userId,
            ca.name AS applicantName,
            p.status_code AS statusCode,
            TO_CHAR(p.submitted_dt, 'YYYY-MM-DD') AS submittedDate,
            p.payment_result AS paymentResult,
            CASE
            	WHEN p.status_code = 'ST_50' THEN '최종 지급 승인'
                WHEN p.status_code = 'ST_80' THEN '추가지급 대기'
                WHEN p.status_code = 'ST_90' THEN '추가지급 결정'
                WHEN p.status_code = 'ST_100' THEN '추가지급 반려'
                ELSE '기타'
            END AS statusName
        FROM TB_PARENTAL_LEAVE_APPLICATION p
        JOIN TB_User u ON p.user_id = u.id
        JOIN TB_CONFIRM_APPLICATION ca ON ca.confirm_number = p.confirm_number
        <include refid="searchCondition"/>
        ORDER BY
            p.application_number DESC
        OFFSET #{pageDTO.startList} ROWS FETCH NEXT #{pageDTO.listSize} ROWS ONLY
    </select>
    
    <select id="selectTotalCount" resultType="int">
        SELECT 
            COUNT(*)
        FROM 
            TB_PARENTAL_LEAVE_APPLICATION p
        JOIN
            TB_User u ON p.user_id = u.id
        <include refid="searchCondition"/>
    </select>

    <select id="selectStatusCount" resultType="int">
        SELECT COUNT(*)
        FROM TB_PARENTAL_LEAVE_APPLICATION
        WHERE status_code = #{statusCode}
          AND delt_at = 'N'
          AND payment_result = #{paymentResult}
    </select>
	

</mapper>