<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.renewal_firstclass.dao.AttachedFileDAO">

<insert id="insertFile" parameterType="com.example.renewal_firstclass.domain.AttachedFileDTO">
  INSERT INTO TB_ATTACHED_FILE (file_id, file_type, file_url, sequence)
  VALUES (#{fileId}, #{fileType}, #{fileUrl}, #{sequence})
</insert>

<select id="selectNextFileId" resultType="long">
  SELECT SEQ_FILE_BUNDLE_ID.NEXTVAL FROM DUAL
</select>

  <select id="selectNextSequence" resultType="int">
    SELECT NVL(MAX(sequence), 0)
    FROM TB_ATTACHED_FILE
    WHERE file_id = #{fileId}
  </select>
  
    <select id="selectOneByFileIdAndSeq"
          parameterType="map"
          resultType="com.example.renewal_firstclass.domain.AttachedFileDTO">
    SELECT
      file_id,
      sequence,
      file_type,
      file_url
    FROM TB_ATTACHED_FILE
    WHERE file_id = #{fileId}
      AND sequence = #{sequence}
  </select>

  <select id="selectFilesByFileId"
        parameterType="long"
        resultType="com.example.renewal_firstclass.domain.AttachedFileDTO">
  SELECT
    file_id,
    sequence,
    file_type,
    file_url
  FROM TB_ATTACHED_FILE
  WHERE file_id = #{fileId}
    ORDER BY
    CASE file_type
      WHEN 'WAGE_PROOF'            THEN 1
      WHEN 'PAYMENT_FROM_EMPLOYER' THEN 2
      WHEN 'OTHER'                 THEN 3
      WHEN 'ELIGIBILITY_PROOF'     THEN 4
      ELSE 999
    END,
    sequence ASC
</select>


<delete id="deleteByFileId" parameterType="long">
  DELETE FROM TB_ATTACHED_FILE
  WHERE file_id = #{fileId}
</delete>

<!-- 특정 시퀀스만 삭제 -->
<delete id="deleteOne" parameterType="map">
  DELETE FROM TB_ATTACHED_FILE
  WHERE file_id = #{fileId}
    AND sequence = #{sequence}
</delete>

<select id="existsOwnedFile" parameterType="map" resultType="int">
  SELECT COUNT(1)
  FROM (
    SELECT c.file_id, c.user_id
    FROM TB_CONFIRM_APPLICATION c
    WHERE c.delt_at = 'N'
    
    UNION ALL
    
    SELECT p.file_id, p.user_id
    FROM TB_PARENTAL_LEAVE_APPLICATION p
    WHERE p.delt_at = 'N'
  ) t
  WHERE t.file_id = #{fileId}
    AND t.user_id = #{userId}
</select>


</mapper>