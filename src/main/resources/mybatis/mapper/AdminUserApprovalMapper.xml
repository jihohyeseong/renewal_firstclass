<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.renewal_firstclass.dao.AdminUserApprovalDAO">
    
<select id="selectAppDetailByAppNo"
        resultType="com.example.renewal_firstclass.domain.AdminUserApprovalDTO">
  SELECT
    /* ===== 신청서 ===== */
    p.application_number,
    p.status_code,
    st_app.name                  AS statusName,
    p.bank_code,
    bank.name                    AS bankName,
    p.account_number,
    p.payment_result,
    p.payment,
    p.submitted_dt,
    p.examine_dt,
    p.rejection_reason_code,
    rj.name                      AS rejectionReasonName,
    p.reject_comment,
    p.gov_info_agree,
    p.center_id,
    p.confirm_number,
    p.user_id,                   -- 신청자 ID
    p.processor_id,
    p.upd_bank_code,
    p.upd_account_number,
    p.file_id,

    /* ===== 확인서 ===== */
    c.start_date,
    c.end_date,
    c.weekly_hours,
    c.regular_wage,
    c.child_name,
    c.child_resi_regi_number,
    c.child_birth_date,
    c.registration_number        AS applicantResiRegiNumber, -- 근로자 주민번호
    c.name                       AS applicantNameFromCA,     -- 근로자 이름
    c.response_name,
    c.response_phone_number,
    c.user_id        AS corpUserId,   -- 회사계정 ID (참고용 필요시)
    c.center_id      AS corpCenterId, -- 회사의 소속 센터 (필요시)
    c.upd_start_date,
    c.upd_end_date,
    c.upd_weekly_hours,
    c.upd_regular_wage,
    
    CASE
      WHEN c.upd_child_name IS NULL
        OR c.upd_child_name = c.child_name
      THEN NULL
      ELSE c.upd_child_name
    END AS upd_child_name,

    CASE
      WHEN c.upd_child_resi_regi_number IS NULL
        OR c.upd_child_resi_regi_number = c.child_resi_regi_number
      THEN NULL
      ELSE c.upd_child_resi_regi_number
    END AS upd_child_resi_regi_number,

    CASE
      WHEN c.upd_child_birth_date IS NULL
        OR c.upd_child_birth_date = c.child_birth_date
      THEN NULL
      ELSE c.upd_child_birth_date
    END AS upd_child_birth_date,
    

    /* ===== 신청자 ===== */
    au.name                      AS applicantName,           -- 신청자 이름
    au.phone_number              AS applicantPhoneNumber,
    au.zip_number				 AS applicantZipNumber,
    au.address_base              AS applicantAddrBase,
    au.address_detail            AS applicantAddrDetail,
    

    /* ===== 회사===== */
    cu.name                      AS businessName,            -- 회사명
    cu.zip_number                  AS businessZipNumber,
    cu.address_base              AS businessAddrBase,
    cu.address_detail            AS businessAddrDetail,
    cu.buisiness_regi_number     AS businessRegiNumber,

    /* ===== 처리자 ===== */
    pu.name                      AS processorName

  FROM TB_PARENTAL_LEAVE_APPLICATION p
  JOIN TB_CONFIRM_APPLICATION c ON c.confirm_number = p.confirm_number

  /* 신청자(근로자) */
  JOIN TB_USER au ON au.id = p.user_id

  /* 처리자(관리자) */
  LEFT JOIN TB_USER pu ON pu.id = p.processor_id

  /* 회사(사업장) — 확인서의 user_id */
  LEFT JOIN TB_USER cu ON cu.id = c.user_id

  /* 코드 */
  LEFT JOIN TB_CODE bank   ON bank.code = p.bank_code
  LEFT JOIN TB_CODE st_app ON st_app.code = p.status_code
  LEFT JOIN TB_CODE rj     ON rj.code   = p.rejection_reason_code

  WHERE p.application_number = #{applicationNumber}
    AND NVL(p.delt_at, 'N') = 'N'
</select>

<!-- 지급 확정 -->
<update id="approveApplicationLevel1">
  UPDATE TB_PARENTAL_LEAVE_APPLICATION
     SET status_code = 'ST_40',
         processor_id = #{processorId}
   WHERE application_number = #{applicationNumber}
     AND delt_at= 'N'
     AND status_code != 'ST_10'
</update>

<!-- 부지급 확정 -->
<update id="rejectApplication">
  UPDATE TB_PARENTAL_LEAVE_APPLICATION
     SET payment_result = 'N',
         rejection_reason_code = #{rejectionReasonCode},
         reject_comment = #{rejectComment},
         examine_dt = SYSDATE, 
         processor_id = #{processorId},
         status_code = 'ST_60'
   WHERE application_number = #{applicationNumber}
     AND delt_at = 'N'
     AND status_code != 'ST_10'
</update>

<!-- 관리자가 상세 페이지 진입 시 검토중으로 변환-->
<update id="whenOpenChangeState">
  UPDATE TB_PARENTAL_LEAVE_APPLICATION
     SET status_code  = 'ST_30'
   WHERE application_number = #{applicationNumber}
     AND delt_at = 'N'
     AND status_code = 'ST_20'
</update>   
    
<update id="updateBankInfoByAppNo">
  UPDATE TB_PARENTAL_LEAVE_APPLICATION
     SET upd_bank_code      = #{updBankCode},
         upd_account_number = #{updAccountNumber}
   WHERE application_number = #{applicationNumber}
     AND delt_at = 'N'
</update>

<update id="updateChildInfoByAppNo">
  UPDATE TB_CONFIRM_APPLICATION
     SET upd_child_name             = #{updChildName},
         upd_child_birth_date       = #{updChildBirthDate},
         upd_child_resi_regi_number = #{updChildResiRegiNumber}
   WHERE confirm_number = (
           SELECT confirm_number
             FROM TB_PARENTAL_LEAVE_APPLICATION
            WHERE application_number = #{applicationNumber}
         )
     AND delt_at = 'N'
</update>
    
    
</mapper>